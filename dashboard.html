<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Charmly Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body { margin:0; font-family:'Inter',sans-serif; display:flex; height:100vh; overflow:hidden; background:#f7f9fc; }
body.dark { background:#121212; color:#eee; }
.sidebar { width:35%; min-width:300px; background:#fff; border-right:1px solid #ddd; display:flex; flex-direction:column; padding:20px; overflow-y:auto; }
.sidebar.dark { background:#1e1e1e; border-color:#333; }
.prompt-box { display:flex; margin-bottom:15px; gap:10px; }
.prompt-box textarea { flex:1; height:80px; border-radius:10px; padding:10px; border:1px solid #ccc; resize:none; font-size:1rem; }
.prompt-box button { padding:10px 20px; border:none; border-radius:10px; background:#0b3d91; color:#fff; cursor:pointer; }
.prompt-box button:hover { background:#0e4fbf; }
.chat { flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:10px; }
.message { padding:10px; border-radius:10px; background:#f0f0f0; }
.message.ai { background:#d9f0ff; }
.message.dark { background:#2a2a2a; }
.preview { flex:1; background:#fff; border-left:1px solid #ddd; }
.preview.dark { background:#1a1a1a; border-color:#333; }
#livePreview { width:100%; height:100%; border:none; }
#themeToggle { position:fixed; top:20px; right:20px; padding:10px 15px; border-radius:10px; background:#0b3d91; color:#fff; border:none; cursor:pointer; }
#themeToggle:hover { background:#0e4fbf; }
button.approve, button.reject { padding:5px 10px; border:none; border-radius:6px; cursor:pointer; margin-right:5px; }
button.approve { background:#0b3d91; color:#fff; }
button.approve:hover { background:#0e4fbf; }
button.reject { background:#ccc; color:#000; }
button.reject:hover { background:#999; }
</style>
</head>
<body>

<div class="sidebar" id="sidebar">
  <div class="prompt-box">
    <textarea id="prompt" placeholder="Describe your website..."></textarea>
    <button id="generate">Send</button>
  </div>
  <div class="chat" id="chat"></div>
</div>

<div class="preview" id="preview">
  <iframe id="livePreview"></iframe>
</div>

<button id="themeToggle">Toggle Dark Mode</button>

<script>
const promptEl = document.getElementById('prompt');
const generateBtn = document.getElementById('generate');
const chatEl = document.getElementById('chat');
const liveIframe = document.getElementById('livePreview');
const themeToggle = document.getElementById('themeToggle');
const body = document.body;
const sidebar = document.getElementById('sidebar');
const preview = document.getElementById('preview');

let pendingUpdate = null;

// Dark Mode
themeToggle.addEventListener('click', ()=> {
  body.classList.toggle('dark');
  sidebar.classList.toggle('dark');
  preview.classList.toggle('dark');
  document.querySelectorAll('.message').forEach(msg=>msg.classList.toggle('dark'));
});

// Load prompt from landing page
const savedPrompt = localStorage.getItem('ai-prompt');
if(savedPrompt) promptEl.value = savedPrompt;

// Typing Effect
async function typeEffect(el,text){
  el.textContent="";
  for(let i=0;i<text.length;i++){
    el.textContent+=text[i];
    await new Promise(r=>setTimeout(r,15));
  }
}

// Add message to chat
function addMessage(text,ai=false){
  const div = document.createElement('div');
  div.className='message'+(ai?' ai':'');
  div.textContent = text;
  chatEl.appendChild(div);
  chatEl.scrollTop = chatEl.scrollHeight;
  return div;
}

// Parse AI response & update live preview
function updateLivePreview(aiText){
  const htmlMatch = aiText.match(/\*\*index\.html:\*\*\s*```html([\s\S]*?)```/);
  const cssMatch = aiText.match(/\*\*style\.css:\*\*\s*```css([\s\S]*?)```/);
  const jsMatch = aiText.match(/\*\*script\.js:\*\*\s*```javascript([\s\S]*?)```/);

  const htmlCode = htmlMatch ? htmlMatch[1].trim() : `<h1>Preview Not Available</h1>`;
  const cssCode = cssMatch ? `<style>${cssMatch[1].trim()}</style>` : '';
  const jsCode = jsMatch ? `<script>${jsMatch[1].trim()}<\/script>` : '';

  liveIframe.srcdoc = htmlCode + cssCode + jsCode;
}

// Approval buttons
function addApprovalButtons(parentDiv, aiText){
  const btnContainer = document.createElement('div');
  btnContainer.style.marginTop='10px';
  btnContainer.style.display='flex';
  
  const approveBtn = document.createElement('button');
  approveBtn.className='approve';
  approveBtn.textContent='Approve';

  const rejectBtn = document.createElement('button');
  rejectBtn.className='reject';
  rejectBtn.textContent='Reject';

  btnContainer.appendChild(approveBtn);
  btnContainer.appendChild(rejectBtn);
  parentDiv.appendChild(btnContainer);

  approveBtn.addEventListener('click', ()=>{
    updateLivePreview(aiText);
    btnContainer.remove();
    pendingUpdate = null;
  });
  rejectBtn.addEventListener('click', ()=>{
    btnContainer.remove();
    pendingUpdate = null;
  });
}

// Generate / follow-up
generateBtn.addEventListener('click', async ()=>{
  const prompt = promptEl.value.trim();
  if(!prompt) return alert("Please enter a description");

  addMessage(prompt,false); // user message
  const aiMsg = addMessage("Generating AI response...",true); // placeholder

  try{
    const res = await fetch('/api/ai-generate',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({prompt})
    });
    const data = await res.json();
    const aiText = data.output||"No response from AI.";

    await typeEffect(aiMsg, aiText);

    pendingUpdate = aiText;
    addApprovalButtons(aiMsg, aiText);

  }catch(err){
    console.error(err);
    aiMsg.textContent = "Error fetching AI response.";
  }
});

// Auto-send if coming from landing page
if(savedPrompt){
  generateBtn.click();
  localStorage.removeItem('ai-prompt');
}
</script>
</body>
</html>
