<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Charmly Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: #f7f9fc;
      color: #333;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      background: #0b3d91;
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 1.2rem;
    }
    #project-name {
      font-weight: 700;
    }
    main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    iframe {
      flex: 1;
      border: none;
      width: 100%;
    }
    #loading {
      text-align: center;
      padding: 20px;
      font-size: 1.2rem;
      color: #666;
    }
  </style>
</head>
<body>
  <header>
    <h1>Project: <span id="project-name">Loading...</span></h1>
    <button onclick="window.location.href='index.html'">← Back</button>
  </header>

  <main>
    <div id="loading">Generating your AI website...</div>
    <iframe id="preview" style="display:none;"></iframe>
  </main>

  <script>
    // Helpers
    function generateRandomName(base = "project") {
      const syllables = ["qua","neo","zen","nova","lyra","flux","gyro","aero","omni","cyra"];
      const random = syllables[Math.floor(Math.random() * syllables.length)];
      const suffix = Math.floor(Math.random() * 1000);
      return `${random}-${base}-${suffix}`;
    }

    async function initDashboard() {
      const prompt = localStorage.getItem("ai-prompt");
      if (!prompt) {
        alert("No prompt found. Redirecting...");
        window.location.href = "index.html";
        return;
      }

      // Project name
      let projectName;
      if (prompt.toLowerCase().includes(" for ")) {
        projectName = prompt.split(" for ")[1].trim().replace(/\s+/g, "-").toLowerCase();
      } else {
        projectName = generateRandomName("site");
      }
      document.getElementById("project-name").textContent = projectName;

      try {
        const res = await fetch("/api/ai-generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt }),
        });

        const data = await res.json();
        if (!data.output) throw new Error("No output from AI");

        // Extract code blocks
        const htmlMatch = data.output.match(/```html([\s\S]*?)```/i);
        const cssMatch = data.output.match(/```css([\s\S]*?)```/i);
        const jsMatch = data.output.match(/```javascript([\s\S]*?)```/i);

        let fullHtml = htmlMatch ? htmlMatch[1].trim() : "<html><body><h1>No HTML generated</h1></body></html>";
        const css = cssMatch ? `<style>${cssMatch[1].trim()}</style>` : "";
        const js = jsMatch ? `<script>${jsMatch[1].trim()}<\/script>` : "";

        // Inject into iframe
        const iframe = document.getElementById("preview");
        const doc = iframe.contentDocument || iframe.contentWindow.document;
        doc.open();
        doc.write(fullHtml.replace("</head>", css + "</head>").replace("</body>", js + "</body>"));
        doc.close();

        document.getElementById("loading").style.display = "none";
        iframe.style.display = "block";
      } catch (err) {
        console.error(err);
        document.getElementById("loading").textContent = "❌ Failed to generate website.";
      }
    }

    initDashboard();
  </script>
</body>
</html>
