<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Charmly Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  body { margin:0; font-family:'Inter', sans-serif; display:flex; height:100vh; overflow:hidden; background:#f7f9fc; }
  body.dark { background:#121212; color:#eee; }
  
  /* Sidebar */
  #sidebar { width:25%; min-width:300px; background:#fff; display:flex; flex-direction:column; justify-content:space-between; border-right:1px solid #ddd; }
  body.dark #sidebar { background:#1e1e1e; border-color:#444; }
  #project-info { padding:20px; border-bottom:1px solid #ddd; }
  body.dark #project-info { border-color:#444; }
  #chat { flex:1; padding:10px; overflow-y:auto; display:flex; flex-direction:column-reverse; }
  #chat-input { display:flex; padding:10px; border-top:1px solid #ddd; }
  body.dark #chat-input { border-color:#444; }
  #chat-input input { flex:1; padding:10px; border-radius:8px; border:1px solid #ccc; margin-right:8px; }
  #chat-input button { padding:10px 15px; background:#0b3d91; color:#fff; border:none; border-radius:8px; cursor:pointer; }
  #chat-input button:hover { background:#0e4fbf; }

  /* Right live preview */
  #preview-container { flex:1; display:flex; flex-direction:column; }
  #preview-header { height:50px; padding:10px; border-bottom:1px solid #ddd; display:flex; justify-content:flex-end; align-items:center; background:#f1f1f1; }
  body.dark #preview-header { background:#1e1e1e; border-color:#444; }
  #preview { flex:1; border:none; }

  /* Chat bubbles */
  .ai-msg { background:#0b3d91; color:#fff; padding:8px 12px; border-radius:12px; margin-bottom:8px; align-self:flex-start; max-width:90%; white-space:pre-wrap; }
  body.dark .ai-msg { background:#4f8ef7; }
  .user-msg { background:#eee; color:#333; padding:8px 12px; border-radius:12px; margin-bottom:8px; align-self:flex-end; max-width:90%; }
  body.dark .user-msg { background:#333; color:#eee; }

  /* Approve / Reject buttons */
  .action-buttons { margin-top:5px; display:flex; gap:5px; }
  .action-buttons button { padding:5px 10px; border:none; border-radius:6px; cursor:pointer; }
  .approve { background:green;color:white; }
  .reject { background:red;color:white; }

</style>
</head>
<body>

<div id="sidebar">
  <div>
    <div id="project-info">
      <h3 id="project-title">Loading project...</h3>
      <p id="project-status">Initializing...</p>
    </div>
    <div id="chat"></div>
  </div>
  <div id="chat-input">
    <input type="text" id="user-input" placeholder="Ask Charmly to add/change something...">
    <button id="send-btn">Send</button>
  </div>
</div>

<div id="preview-container">
  <div id="preview-header">
    <button id="toggle-theme">Toggle Dark</button>
  </div>
  <iframe id="preview"></iframe>
</div>

<script>
const chat = document.getElementById("chat");
const preview = document.getElementById("preview");
const sendBtn = document.getElementById("send-btn");
const userInput = document.getElementById("user-input");
const toggleTheme = document.getElementById("toggle-theme");
const body = document.body;

// Get the prompt from localStorage
const initialPrompt = localStorage.getItem("ai-prompt") || "Make a sample website";
document.getElementById("project-title").innerText = initialPrompt;
document.getElementById("project-status").innerText = "Generating initial preview...";

// Helper to show AI messages in chat
function addAIMessage(msg, htmlContent=null){
  const bubble = document.createElement("div");
  bubble.className = "ai-msg";
  bubble.innerText = msg;

  // Add approve/reject buttons if HTML content is provided
  if(htmlContent){
    const btns = document.createElement("div");
    btns.className = "action-buttons";

    const approve = document.createElement("button");
    approve.className = "approve";
    approve.innerText = "Approve";
    approve.onclick = ()=>{ preview.srcdoc = htmlContent; bubble.remove(); };

    const reject = document.createElement("button");
    reject.className = "reject";
    reject.innerText = "Reject";
    reject.onclick = ()=>{ bubble.remove(); };

    btns.appendChild(approve);
    btns.appendChild(reject);
    bubble.appendChild(document.createElement("br"));
    bubble.appendChild(btns);
  }

  chat.prepend(bubble);
}

// Simulate extraction of essential additions (images/scripts/styles)
function extractDiff(fullHTML){
  let essential="";
  // Extract <style>, <script>, <img> tags
  const styleMatches = fullHTML.match(/<style[\s\S]*?<\/style>/gi);
  const scriptMatches = fullHTML.match(/<script[\s\S]*?<\/script>/gi);
  const imgMatches = fullHTML.match(/<img[\s\S]*?>/gi);
  if(styleMatches) essential+=styleMatches.join("\n")+"\n";
  if(scriptMatches) essential+=scriptMatches.join("\n")+"\n";
  if(imgMatches) essential+=imgMatches.join("\n")+"\n";
  return essential || "Essential additions only.";
}

// Function to call AI backend
async function callAI(prompt){
  const res = await fetch("/api/ai-generate",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({prompt})
  });
  const data = await res.json();
  const htmlContent = data.output || "<p>No preview</p>";

  addAIMessage("Charmly generated essential additions. Approve to update live preview.", htmlContent);
}

// Initial AI generation
callAI(initialPrompt);

// Handle user input
sendBtn.addEventListener("click", ()=>{
  const prompt = userInput.value.trim();
  if(!prompt) return;
  // Add user message
  const bubble = document.createElement("div");
  bubble.className="user-msg";
  bubble.innerText = prompt;
  chat.prepend(bubble);
  userInput.value="";
  callAI(prompt);
});

// Dark toggle
toggleTheme.addEventListener("click", ()=>{ body.classList.toggle("dark"); });

</script>

</body>
</html>
