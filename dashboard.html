<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Charmly Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body { margin:0; font-family:'Inter',sans-serif; display:flex; height:100vh; overflow:hidden; }
.sidebar { width:300px; background:#f7f9fc; display:flex; flex-direction:column; border-right:1px solid #ccc; }
.chat-header { padding:15px; font-weight:600; border-bottom:1px solid #ccc; }
.chat-messages { flex:1; padding:10px; overflow-y:auto; }
.chat-input { display:flex; padding:10px; border-top:1px solid #ccc; }
.chat-input textarea { flex:1; resize:none; border-radius:8px; padding:8px; border:1px solid #ccc; }
.chat-input button { margin-left:5px; padding:8px 12px; border:none; border-radius:8px; background:#0b3d91; color:#fff; cursor:pointer; }
.topbar { height:50px; flex-shrink:0; background:#fff; display:flex; justify-content:space-between; align-items:center; padding:0 20px; border-bottom:1px solid #ccc; }
.topbar .actions button { margin-left:10px; padding:6px 12px; border-radius:6px; border:none; cursor:pointer; }
.topbar .actions .upgrade { background:#f97316; color:#fff; }
.preview { flex:1; background:#fff; overflow:hidden; }
iframe { width:100%; height:100%; border:none; }
.approve-buttons { margin-top:10px; display:flex; gap:5px; }
.approve-buttons button { flex:1; padding:5px 0; border:none; border-radius:6px; cursor:pointer; }
.approve-buttons .approve { background:#10b981; color:#fff; }
.approve-buttons .reject { background:#ef4444; color:#fff; }
</style>
</head>
<body>

<div class="sidebar">
  <div class="chat-header">Ask Charmly...</div>
  <div class="chat-messages" id="chatMessages"></div>
  <div class="chat-input">
    <textarea id="prompt" rows="2" placeholder="Describe your website/game..."></textarea>
    <button id="sendBtn">Send</button>
  </div>
</div>

<div style="flex:1; display:flex; flex-direction:column;">
  <div class="topbar">
    <div class="project-name">bird-bop-bonanza</div>
    <div class="actions">
      <button>Invite</button>
      <button class="upgrade">Upgrade</button>
      <button>Publish</button>
    </div>
  </div>
  <div class="preview">
    <iframe id="preview"></iframe>
  </div>
</div>

<script>
const chatMessages = document.getElementById("chatMessages");
const sendBtn = document.getElementById("sendBtn");
const promptInput = document.getElementById("prompt");
const previewFrame = document.getElementById("preview");

function extractCodeBlocks(text){
  const regex = /```(html|css|javascript)\s([\s\S]*?)```/g;
  const blocks = { html:"", css:"", js:"" };
  let match;
  while((match = regex.exec(text)) !== null){
    const type = match[1].toLowerCase();
    const code = match[2].trim();
    if(blocks[type]) blocks[type] += "\n" + code;
    else blocks[type] = code;
  }
  return blocks;
}

function getChatText(text){ return text.replace(/```(html|css|javascript)[\s\S]*?```/g,"").trim(); }

function renderPreview(blocks){
  const doc = previewFrame.contentDocument || previewFrame.contentWindow.document;
  doc.open();
  doc.write(blocks.html || "<body></body>");
  if(blocks.css){
    const style = doc.createElement("style");
    style.textContent = blocks.css;
    doc.head.appendChild(style);
  }
  if(blocks.js){
    const script = doc.createElement("script");
    script.textContent = blocks.js;
    doc.body.appendChild(script);
  }
  doc.close();
}

function addChatMessage(msg, blocks){
  const div = document.createElement("div");
  div.style.marginBottom = "12px";
  const textP = document.createElement("p");
  textP.textContent = msg;
  div.appendChild(textP);
  if(blocks.html || blocks.css || blocks.js){
    const btnDiv = document.createElement("div");
    btnDiv.className = "approve-buttons";
    const approve = document.createElement("button");
    approve.textContent = "Approve";
    approve.className = "approve";
    approve.onclick = ()=> renderPreview(blocks);
    const reject = document.createElement("button");
    reject.textContent = "Reject";
    reject.className = "reject";
    reject.onclick = ()=> addChatMessage("Changes rejected.", {});
    btnDiv.appendChild(approve);
    btnDiv.appendChild(reject);
    div.appendChild(btnDiv);
  }
  chatMessages.appendChild(div);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

async function sendPrompt(prompt){
  addChatMessage("Generating AI response...", {});
  try{
    const res = await fetch("/api/ai-generate", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({prompt})
    });
    const data = await res.json();
    const aiText = data.chat || "No response from AI.";
    const blocks = extractCodeBlocks(data.output || "");
    const chatText = getChatText(aiText) || "AI generated code. Approve to apply.";
    addChatMessage(chatText, blocks);
  } catch(err){
    console.error(err);
    addChatMessage("Error generating content.", {});
  }
}

sendBtn.addEventListener("click", ()=>{
  const prompt = promptInput.value.trim();
  if(!prompt) return alert("Type something first!");
  sendPrompt(prompt);
});

// Auto-send initial prompt from landing page
const initialPrompt = localStorage.getItem("ai-prompt");
if(initialPrompt){ promptInput.value = initialPrompt; sendPrompt(initialPrompt); }
</script>
</body>
</html>
