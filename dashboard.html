<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Charmly Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
body, html { margin:0; padding:0; font-family:'Inter',sans-serif; height:100%; overflow:hidden; background:#f5f5f7; }
header { height:50px; display:flex; justify-content:space-between; align-items:center; padding:0 20px; background:#fff; border-bottom:1px solid #ddd; flex-shrink:0; }
header .left-btn { font-weight:600; }
header .right-buttons button { margin-left:10px; padding:6px 15px; border-radius:8px; border:none; cursor:pointer; font-weight:600; }
header .right-buttons .upgrade { background:#0b3d91; color:white; }

.dashboard { display:flex; height:calc(100% - 50px); }
.sidebar { width:25%; background:#fff; border-right:1px solid #ddd; display:flex; flex-direction:column; justify-content:space-between; }
.sidebar-top { padding:20px; }
.project-name { display:flex; align-items:center; gap:8px; font-weight:600; margin-bottom:10px; }
.status { font-size:0.9rem; color:#888; display:flex; align-items:center; gap:5px; }
.sidebar-top-icons { display:flex; gap:10px; margin-top:10px; font-size:1.2rem; cursor:pointer; }
.sidebar-bottom { padding:15px; border-top:1px solid #eee; display:flex; flex-direction:column; gap:10px; }
.chat-title { font-weight:500; margin-bottom:5px; }
.chat-input { display:flex; gap:5px; }
.chat-input input { flex:1; padding:8px 12px; border-radius:8px; border:1px solid #ccc; }
.chat-icons { display:flex; gap:5px; margin-top:5px; }
.chat-icons span { cursor:pointer; font-size:1.2rem; }

.main { flex:1; display:flex; flex-direction:column; padding:20px; overflow:hidden; }
.preview { flex:1; display:flex; justify-content:center; align-items:center; background:#eaeaea; border-radius:12px; margin-bottom:15px; position:relative; }
.preview iframe { width:100%; height:100%; border:none; border-radius:12px; }
.placeholder { display:flex; flex-direction:column; align-items:center; color:#888; font-size:1.2rem; }
.features { display:flex; gap:15px; }
.feature { display:flex; align-items:center; gap:10px; background:#fff; padding:10px 15px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.05); flex:1; }
.feature span { font-size:1.2rem; }
</style>
</head>
<body>

<header>
  <div class="left-btn">make a flappy bird game</div>
  <div class="right-buttons">
    <button>Invite</button>
    <button class="upgrade">Upgrade</button>
    <button>Publish</button>
  </div>
</header>

<div class="dashboard">
  <div class="sidebar">
    <div class="sidebar-top">
      <div class="project-name">üê¶ bird-bop-bonanza</div>
      <div class="status">‚è≥ Loading Live Preview</div>
      <div class="sidebar-top-icons">‚ãÆ &lt;/&gt; üìÑ</div>
    </div>
    <div class="sidebar-bottom">
      <div class="chat-title">Ask Charmly...</div>
      <div class="chat-input">
        <input type="text" id="userInputSidebar" placeholder="Type your request...">
        <button id="sendSidebar">Send</button>
      </div>
      <div class="chat-icons">
        <span>‚úèÔ∏è</span>
        <span>üí¨</span>
        <span>üé§</span>
      </div>
      <div id="chatSidebar" style="margin-top:10px; overflow-y:auto; max-height:200px; display:flex; flex-direction:column; gap:5px;"></div>
    </div>
  </div>

  <div class="main">
    <div class="preview" id="livePreviewContainer">
      <div class="placeholder" id="placeholderContent">
        <div style="font-size:50px;">üíñ</div>
        <div>Spinning up preview...</div>
      </div>
      <iframe id="livePreview"></iframe>
    </div>
    <div class="features">
      <div class="feature"><span>‚ö°</span> Instantly preview your changes</div>
      <div class="feature"><span>üìö</span> Set custom knowledge for every edit</div>
      <div class="feature"><span>üíæ</span> Connect Supabase for backend</div>
    </div>
  </div>
</div>

<script>
const chatSidebar = document.getElementById('chatSidebar');
const inputSidebar = document.getElementById('userInputSidebar');
const sendSidebar = document.getElementById('sendSidebar');
const livePreview = document.getElementById('livePreview');
const placeholder = document.getElementById('placeholderContent');

function addSidebarMessage(text, sender='ai') {
  const div = document.createElement('div');
  div.style.padding='8px 12px';
  div.style.borderRadius='10px';
  div.style.maxWidth='80%';
  div.style.alignSelf= sender==='ai' ? 'flex-start' : 'flex-end';
  div.style.background= sender==='ai' ? '#e2e2e2' : '#0b3d91';
  div.style.color= sender==='ai' ? '#333' : 'white';
  div.textContent = text;
  chatSidebar.appendChild(div);
  chatSidebar.scrollTop = chatSidebar.scrollHeight;
}

async function typeEffect(element, text){
  element.textContent = '';
  for(let i=0;i<text.length;i++){
    element.textContent += text[i];
    await new Promise(r=>setTimeout(r,10));
  }
}

function extractDiff(fullHTML){
  let diff = fullHTML.replace(/<html[\s\S]*?>|<\/html>/gi,'')
                     .replace(/<head[\s\S]*?>[\s\S]*?<\/head>/gi,'')
                     .replace(/<body[\s\S]*?>|<\/body>/gi,'').trim();
  const additions = diff.match(/<img[\s\S]*?>|<script[\s\S]*?<\/script>|<style[\s\S]*?<\/style>/gi);
  return additions ? additions.join('\n') : 'I added the main structure. You can now add images, sounds, etc.';
}

sendSidebar.addEventListener('click', async ()=>{
  const userText = inputSidebar.value.trim();
  if(!userText) return;
  addSidebarMessage(userText,'user');
  inputSidebar.value='';

  const aiMsg = addSidebarMessage('Generating AI response...');
  try{
    const res = await fetch('/api/ai-generate',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({prompt:userText})
    });
    const data = await res.json();
    const fullAIOutput = data.output || "<h2>No output</h2>";

    // Update live preview iframe
    livePreview.srcdoc = fullAIOutput;
    placeholder.style.display='none';

    // Show only diff in chat
    const diffText = extractDiff(fullAIOutput);
    await typeEffect(aiMsg, diffText);

    // Add approve/reject buttons
    const approveContainer = document.createElement('div');
    approveContainer.style.marginTop='5px';
    approveContainer.style.display='flex';
    approveContainer.style.gap='5px';
    const approveBtn = document.createElement('button');
    approveBtn.textContent='Approve';
    approveBtn.style.background='#4caf50';
    approveBtn.style.color='white';
    approveBtn.style.border='none';
    approveBtn.style.padding='4px 8px';
    approveBtn.style.borderRadius='6px';
    approveBtn.style.cursor='pointer';
    approveBtn.onclick = ()=>{ alert('Changes approved!'); };
    const rejectBtn = document.createElement('button');
    rejectBtn.textContent='Reject';
    rejectBtn.style.background='#f44336';
    rejectBtn.style.color='white';
    rejectBtn.style.border='none';
    rejectBtn.style.padding='4px 8px';
    rejectBtn.style.borderRadius='6px';
    rejectBtn.style.cursor='pointer';
    rejectBtn.onclick = ()=>{ alert('Changes rejected!'); };
    approveContainer.appendChild(approveBtn);
    approveContainer.appendChild(rejectBtn);
    chatSidebar.appendChild(approveContainer);

  }catch(err){
    console.error(err);
    aiMsg.textContent = "Error fetching AI response.";
  }
});

inputSidebar.addEventListener('keydown', e=>{
  if(e.key==='Enter') sendSidebar.click();
});
</script>

</body>
</html>
