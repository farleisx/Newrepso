<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Charmly Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  body, html { margin:0; padding:0; height:100%; font-family:'Inter',sans-serif; display:flex; overflow:hidden; }
  .chat-container { width:35%; border-right:1px solid #ddd; display:flex; flex-direction:column; background:#f9f9f9; }
  .chat-messages { flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:10px; }
  .chat-message { padding:10px 15px; border-radius:12px; max-width:80%; }
  .chat-user { background:#0b3d91; color:white; align-self:flex-end; }
  .chat-ai { background:#e2e2e2; color:#333; align-self:flex-start; white-space:pre-wrap; }
  .chat-input { padding:10px; border-top:1px solid #ccc; display:flex; gap:10px; }
  .chat-input input { flex:1; padding:10px 15px; border-radius:12px; border:1px solid #ccc; font-size:1rem; }
  .chat-input button { padding:10px 20px; border:none; border-radius:12px; background:#0b3d91; color:white; cursor:pointer; }
  .approve-buttons { margin-top:5px; display:flex; gap:10px; }
  .approve-buttons button { padding:5px 10px; border-radius:8px; border:none; cursor:pointer; }
  .approve { background:#4caf50; color:white; }
  .reject { background:#f44336; color:white; }

  .preview-container { flex:1; background:#fff; }
  iframe { width:100%; height:100%; border:none; }

  .typing { border-right:2px solid #0b3d91; }
</style>
</head>
<body>

<div class="chat-container">
  <div class="chat-messages" id="chat"></div>
  <div class="chat-input">
    <input type="text" id="userInput" placeholder="Type your request...">
    <button id="sendBtn">Send</button>
  </div>
</div>

<div class="preview-container">
  <iframe id="livePreview"></iframe>
</div>

<script>
const chatEl = document.getElementById('chat');
const inputEl = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');
const livePreview = document.getElementById('livePreview');

function addMessage(text, sender='ai', html=false){
  const div = document.createElement('div');
  div.className = 'chat-message ' + (sender==='ai'?'chat-ai':'chat-user');
  if(html) div.innerHTML = text;
  else div.textContent = text;
  chatEl.appendChild(div);
  chatEl.scrollTop = chatEl.scrollHeight;
  return div;
}

// Typing effect
async function typeEffect(element, text){
  element.textContent = '';
  element.classList.add('typing');
  for(let i=0;i<text.length;i++){
    element.textContent += text[i];
    await new Promise(r=>setTimeout(r,15));
  }
  element.classList.remove('typing');
}

// Simulate extracting “diff” from AI full output
function extractDiff(fullHTML){
  // Remove <html>, <body>, <head> wrappers
  let diff = fullHTML.replace(/<html[\s\S]*?>|<\/html>/gi,'')
                     .replace(/<head[\s\S]*?>[\s\S]*?<\/head>/gi,'')
                     .replace(/<body[\s\S]*?>|<\/body>/gi,'').trim();
  // Show only additions like <img>, <script>, <style> tags
  const additions = diff.match(/<img[\s\S]*?>|<script[\s\S]*?<\/script>|<style[\s\S]*?<\/style>/gi);
  return additions ? additions.join('\n') : 'I added the main structure. You can now add images, sounds, etc.';
}

// Approve / Reject buttons
function addApprovalButtons(parentDiv, fullHTML){
  const container = document.createElement('div');
  container.className = 'approve-buttons';
  const approveBtn = document.createElement('button');
  approveBtn.className = 'approve';
  approveBtn.textContent = 'Approve';
  approveBtn.onclick = ()=>{ alert('Changes approved!'); };
  const rejectBtn = document.createElement('button');
  rejectBtn.className = 'reject';
  rejectBtn.textContent = 'Reject';
  rejectBtn.onclick = ()=>{ alert('Changes rejected!'); };
  container.appendChild(approveBtn);
  container.appendChild(rejectBtn);
  parentDiv.appendChild(container);
}

// Handle sending
sendBtn.addEventListener('click', async ()=>{
  const userText = inputEl.value.trim();
  if(!userText) return;
  addMessage(userText,'user');
  inputEl.value='';

  const aiMsg = addMessage("Generating AI response...");
  try{
    const res = await fetch('/api/ai-generate',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({prompt:userText})
    });
    const data = await res.json();
    const fullAIOutput = data.output || "<h2>No output</h2>";

    // Update live preview with full AI HTML
    livePreview.srcdoc = fullAIOutput;

    // Show only diff in chat with typing effect
    const diffText = extractDiff(fullAIOutput);
    await typeEffect(aiMsg, diffText);

    addApprovalButtons(aiMsg, fullAIOutput);

  }catch(err){
    console.error(err);
    aiMsg.textContent = "Error fetching AI response.";
  }
});

// Enter key support
inputEl.addEventListener('keydown', e=>{
  if(e.key==='Enter') sendBtn.click();
});
</script>

</body>
</html>
