<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Charmly Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  *{box-sizing:border-box;margin:0;padding:0;font-family:'Inter',sans-serif;}
  body{display:flex;height:100vh;overflow:hidden;background:#f7f9fc;}
  body.dark{background:#121212;color:#eee;}

  /* Left sidebar */
  #sidebar{width:25%;background:#fff;border-right:1px solid #ddd;display:flex;flex-direction:column;}
  #project-info{padding:20px;border-bottom:1px solid #ddd;}
  #chat{flex:1;display:flex;flex-direction:column;padding:10px;overflow-y:auto;}
  .message{background:#eef2ff;margin:5px 0;padding:8px 12px;border-radius:12px;box-shadow:0 2px 5px rgba(0,0,0,0.1);}
  .message.ai{background:#d1fae5;align-self:flex-start;}
  .message.user{background:#c7d2fe;align-self:flex-end;}
  .message button{margin-left:5px;padding:2px 6px;border:none;border-radius:6px;cursor:pointer;}
  #input-container{display:flex;padding:10px;border-top:1px solid #ddd;}
  #input-container input{flex:1;padding:8px 12px;border-radius:12px;border:1px solid #ccc;}
  #input-container button{margin-left:8px;padding:8px 12px;border:none;border-radius:12px;background:#4f46e5;color:#fff;cursor:pointer;}

  /* Top bar */
  #topbar{position:fixed;top:0;left:25%;width:75%;height:50px;background:#fff;border-bottom:1px solid #ddd;display:flex;justify-content:space-between;align-items:center;padding:0 20px;z-index:50;}
  #topbar button{margin-left:10px;padding:6px 12px;border:none;border-radius:8px;cursor:pointer;}
  #topbar .highlight{background:#4f46e5;color:#fff;}

  /* Main content */
  #main{margin-top:50px;margin-left:25%;width:75%;flex:1;display:flex;flex-direction:column;}
  #preview-container{flex:1;background:#fff;display:flex;justify-content:center;align-items:center;position:relative;overflow:auto;}
  #preview{width:100%;height:100%;border:none;}

  /* Features */
  #features{display:flex;justify-content:space-around;padding:10px;background:#f0f4ff;border-top:1px solid #ddd;}

  /* Typing effect */
  .typing{border-right:2px solid #4f46e5;white-space:pre-wrap;overflow-wrap:break-word;}
</style>
</head>
<body>

<!-- Left Sidebar -->
<div id="sidebar">
  <div id="project-info">
    <h2>bird-bop-bonanza ðŸ’–</h2>
    <p id="status">Loading Live Preview...</p>
  </div>
  <div id="chat"></div>
  <div id="input-container">
    <input type="text" id="chat-input" placeholder="Ask Charmly to change something..." />
    <button id="send-btn">Send</button>
  </div>
</div>

<!-- Top Bar -->
<div id="topbar">
  <div id="current-command">make a flappy bird game</div>
  <div>
    <button>Invite</button>
    <button class="highlight">Upgrade</button>
    <button>Publish</button>
  </div>
</div>

<!-- Main Content / Live Preview -->
<div id="main">
  <div id="preview-container">
    <iframe id="preview"></iframe>
  </div>
  <div id="features">
    <div>Instantly preview your changes</div>
    <div>Set custom knowledge for every edit</div>
    <div>Connect Supabase for backend</div>
  </div>
</div>

<script>
// Elements
const chat=document.getElementById("chat");
const input=document.getElementById("chat-input");
const sendBtn=document.getElementById("send-btn");
const preview=document.getElementById("preview");
const status=document.getElementById("status");

// Typing effect
async function typeEffect(el,text){
  el.textContent="";
  el.classList.add("typing");
  for(let i=0;i<text.length;i++){
    el.textContent+=text[i];
    await new Promise(r=>setTimeout(r,10));
  }
  el.classList.remove("typing");
}

// Extract essential additions (<style>, <img>, <script>)
function extractDiff(html){
  const matches=html.match(/<style[\s\S]*?<\/style>|<script[\s\S]*?<\/script>|<img[^>]*>/gi);
  return matches?matches.join("\n"):"No additional elements to add";
}

// Add AI message
function addAIMessage(content, fullHTML){
  const msg=document.createElement("div");
  msg.className="message ai";
  msg.innerHTML=content;

  const approveBtn=document.createElement("button");
  approveBtn.textContent="Approve";
  approveBtn.onclick=()=>{
    preview.srcdoc=fullHTML;
    status.textContent="Preview Updated!";
  };
  const rejectBtn=document.createElement("button");
  rejectBtn.textContent="Reject";
  rejectBtn.onclick=()=>{alert("Changes rejected!");};

  msg.appendChild(approveBtn);
  msg.appendChild(rejectBtn);
  chat.appendChild(msg);
  chat.scrollTop=chat.scrollHeight;
}

// Load AI output
window.addEventListener("DOMContentLoaded",()=>{
  const aiOutput=localStorage.getItem("latestAIOutput");
  if(aiOutput){
    preview.srcdoc=aiOutput;
    status.textContent="Preview Ready";
    const diff=extractDiff(aiOutput);
    addAIMessage("Charmly generated initial project. Essential additions:\n"+diff,aiOutput);
    localStorage.removeItem("latestAIOutput");
  }else{
    status.textContent="No project loaded";
  }
});

// Send command
sendBtn.addEventListener("click",async ()=>{
  const text=input.value.trim();
  if(!text) return;

  const userMsg=document.createElement("div");
  userMsg.className="message user";
  userMsg.textContent=text;
  chat.appendChild(userMsg);
  chat.scrollTop=chat.scrollHeight;
  input.value="";

  // Fetch AI changes from backend
  const res=await fetch("/api/ai-generate",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({prompt:text})
  });
  const data=await res.json();
  const aiText=data.output||"No AI response";
  const diff=extractDiff(aiText);

  addAIMessage("Charmly suggests changes:\n"+diff, aiText);
});

input.addEventListener("keydown",e=>{
  if(e.key==="Enter") sendBtn.click();
});
</script>

</body>
</html>
