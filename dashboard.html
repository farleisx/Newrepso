<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Charmly Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  * { box-sizing: border-box; margin:0; padding:0; font-family:'Inter',sans-serif; transition: background 0.3s, color 0.3s; }
  body { display: flex; height:100vh; overflow:hidden; background: var(--bg-color); color: var(--text-color); }
  :root {
    --bg-color:#f7f9fc;
    --text-color:#333;
    --accent:#0b3d91;
    --card-bg:#fff;
    --card-shadow:rgba(0,0,0,0.05);
  }
  body.dark {
    --bg-color:#121212;
    --text-color:#eee;
    --accent:#4f8ef7;
    --card-bg:#1e1e1e;
    --card-shadow:rgba(0,0,0,0.4);
  }

  /* Sidebar */
  #sidebar { width:25%; background:var(--card-bg); display:flex; flex-direction:column; border-right:1px solid #ccc; }
  #chat-area { flex:1; overflow-y:auto; padding:10px; }
  #chat-area p { margin-bottom:10px; }
  #input-area { display:flex; padding:10px; border-top:1px solid #ccc; }
  #prompt { flex:1; padding:8px; border-radius:8px; border:1px solid #ccc; }
  #send-btn { margin-left:8px; padding:8px 12px; background:var(--accent); color:#fff; border:none; border-radius:8px; cursor:pointer; }

  /* Main preview */
  #main { flex:1; display:flex; flex-direction:column; }
  #top-bar { height:50px; background:var(--card-bg); border-bottom:1px solid #ccc; display:flex; align-items:center; justify-content:space-between; padding:0 20px; }
  #iframe-container { flex:1; }
  iframe { width:100%; height:100%; border:none; }

  /* Dark mode toggle */
  #theme-toggle { position:fixed; top:15px; right:15px; padding:6px 12px; border:none; border-radius:8px; background:var(--accent); color:#fff; cursor:pointer; }

</style>
</head>
<body>

<div id="sidebar">
  <div id="chat-area">
    <p><strong>AI Suggestions:</strong></p>
  </div>
  <div id="input-area">
    <input type="text" id="prompt" placeholder="Ask Charmly...">
    <button id="send-btn">Send</button>
  </div>
</div>

<div id="main">
  <div id="top-bar">
    <div id="project-name">Project: <span id="proj-title"></span></div>
    <div>
      <button id="approve-btn">Approve Plan</button>
      <button id="reject-btn">Reject</button>
    </div>
  </div>
  <div id="iframe-container">
    <iframe id="live-preview"></iframe>
  </div>
</div>

<button id="theme-toggle">Dark Mode</button>

<script>
  const chatArea = document.getElementById("chat-area");
  const promptInput = document.getElementById("prompt");
  const sendBtn = document.getElementById("send-btn");
  const livePreview = document.getElementById("live-preview");
  const projTitle = document.getElementById("proj-title");
  const approveBtn = document.getElementById("approve-btn");
  const rejectBtn = document.getElementById("reject-btn");
  const themeToggle = document.getElementById("theme-toggle");

  // Load prompt from index.html
  const savedPrompt = localStorage.getItem("ai-prompt") || "Your project";
  projTitle.textContent = savedPrompt;

  themeToggle.addEventListener("click", () => document.body.classList.toggle("dark"));

  function appendChat(message) {
    const p = document.createElement("p");
    p.textContent = message;
    chatArea.appendChild(p);
    chatArea.scrollTop = chatArea.scrollHeight;
  }

  async function sendPrompt(prompt) {
    appendChat("You: " + prompt);
    appendChat("AI: Generating...");

    // Call your backend API
    try {
      const res = await fetch("/api/ai-generate", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ prompt })
      });
      const data = await res.json();
      const aiText = data.output || "AI did not return any output.";

      // Show only suggestions in chat
      appendChat("AI suggests: Add images, sounds, or scripts. Key changes only.");

      // Extract <style>, <script>, <img> only
      const styleMatch = aiText.match(/```css([\s\S]*?)```/);
      const jsMatch = aiText.match(/```javascript([\s\S]*?)```/);
      const htmlMatch = aiText.match(/```html([\s\S]*?)```/);

      const iframeDoc = livePreview.contentDocument || livePreview.contentWindow.document;
      iframeDoc.open();
      iframeDoc.write(`
        <html>
          <head>
            <style>${styleMatch ? styleMatch[1] : ""}</style>
          </head>
          <body>
            ${htmlMatch ? htmlMatch[1] : ""}
            <script>${jsMatch ? jsMatch[1] : ""}<\/script>
          </body>
        </html>
      `);
      iframeDoc.close();

    } catch(err) {
      console.error(err);
      appendChat("Error fetching AI response.");
    }
  }

  sendBtn.addEventListener("click", () => {
    const prompt = promptInput.value.trim();
    if(!prompt) return alert("Enter a prompt!");
    sendPrompt(prompt);
    promptInput.value = "";
  });

  // Approve/Reject buttons
  approveBtn.addEventListener("click", () => appendChat("Plan approved! AI will continue."));
  rejectBtn.addEventListener("click", () => appendChat("Plan rejected. Modify and resend."));
</script>

</body>
</html>
